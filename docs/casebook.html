<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Casebook — AB Factory</title>
<style>
:root {
  --bg: #fafafa; --fg: #1d1d1f; --muted: #6e6e73;
  --accent: #0071e3; --accent-hover: #0077ed;
  --card-bg: #fff; --border: #d2d2d7; --hover-bg: #f0f0f5;
  --green: #34c759; --red: #ff3b30; --orange: #ff9500;
  --radius: 12px;
}
@media(prefers-color-scheme:dark){:root{
  --bg:#000; --fg:#f5f5f7; --muted:#86868b;
  --accent:#2997ff; --accent-hover:#40a9ff;
  --card-bg:#1c1c1e; --border:#38383a; --hover-bg:#2c2c2e;
  --green:#30d158; --red:#ff453a; --orange:#ffa00a;
}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg);line-height:1.5;-webkit-font-smoothing:antialiased}

.top-bar{position:sticky;top:0;background:color-mix(in srgb,var(--bg) 80%,transparent);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;z-index:10}
.top-bar a{color:var(--accent);text-decoration:none;font-size:14px;font-weight:500}
.top-bar .title{font-weight:600;font-size:15px;color:var(--fg)}

.container{max-width:960px;margin:0 auto;padding:32px 24px 80px}
h1{font-size:28px;font-weight:700;margin-bottom:4px}
.subtitle{color:var(--muted);font-size:15px;margin-bottom:24px}

.filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
.filters input[type=text]{padding:8px 14px;border:1px solid var(--border);border-radius:8px;background:var(--card-bg);color:var(--fg);font-size:14px;width:220px;outline:none}
.filters input[type=text]:focus{border-color:var(--accent)}
.filters select{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card-bg);color:var(--fg);font-size:14px;outline:none;cursor:pointer}
.filters label{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
.filters input[type=range]{width:100px;accent-color:var(--accent)}
.filter-count{font-size:13px;color:var(--muted);margin-left:auto}

table{width:100%;border-collapse:collapse}
thead th{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;padding:10px 12px;text-align:left;border-bottom:2px solid var(--border);user-select:none;cursor:pointer}
thead th:hover{color:var(--fg)}
thead th .arrow{font-size:10px;margin-left:4px;opacity:0.4}
thead th.sorted .arrow{opacity:1;color:var(--accent)}
tbody tr{cursor:pointer;transition:background 0.15s}
tbody tr:hover{background:var(--hover-bg)}
tbody td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}

.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:12px;font-weight:600;letter-spacing:0.02em}
.badge-ship{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.badge-do_not_ship{background:color-mix(in srgb,var(--red) 15%,transparent);color:var(--red)}
.badge-investigate{background:color-mix(in srgb,var(--orange) 15%,transparent);color:var(--orange)}

.conf-bar{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-variant-numeric:tabular-nums}
.conf-bar .bar{width:48px;height:6px;border-radius:3px;background:var(--border);overflow:hidden;position:relative}
.conf-bar .bar .fill{height:100%;border-radius:3px;transition:width 0.3s}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;display:none;justify-content:flex-end;animation:fadeIn 0.2s}
.overlay.open{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.drawer{width:min(520px,100vw);background:var(--card-bg);height:100%;overflow-y:auto;padding:32px 28px;animation:slideIn 0.25s ease-out;border-left:1px solid var(--border)}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.drawer-close{background:none;border:none;font-size:24px;color:var(--muted);cursor:pointer;position:absolute;top:16px;right:20px}
.drawer-close:hover{color:var(--fg)}
.drawer h2{font-size:20px;font-weight:700;margin-bottom:4px;padding-right:32px}
.drawer .meta{color:var(--muted);font-size:13px;margin-bottom:20px}
.drawer section{margin-bottom:24px}
.drawer section h3{font-size:14px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:8px}
.drawer .kv{display:grid;grid-template-columns:140px 1fr;gap:4px 12px;font-size:14px}
.drawer .kv dt{color:var(--muted);font-weight:500}
.drawer .kv dd{word-break:break-word}
.drawer .rationale{font-size:14px;line-height:1.65;color:var(--fg);background:var(--bg);padding:16px;border-radius:8px;border:1px solid var(--border)}
.drawer .tags{display:flex;flex-wrap:wrap;gap:6px}
.drawer .tag{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:12px;font-weight:500}
</style>
</head>
<body>

<div class="top-bar">
  <a href="index.html">&larr; Home</a>
  <span class="title">Casebook</span>
</div>

<div class="container">
  <h1>Golden Cases</h1>
  <p class="subtitle">Five hand-crafted A/B test scenarios evaluated by the agent pipeline.</p>

  <div class="filters">
    <input type="text" id="search" placeholder="Search cases…">
    <select id="decisionFilter">
      <option value="">All decisions</option>
      <option value="ship">ship</option>
      <option value="do_not_ship">do_not_ship</option>
      <option value="investigate">investigate</option>
    </select>
    <label>
      Min confidence
      <input type="range" id="confRange" min="0" max="99" value="0">
      <span id="confLabel">0%</span>
    </label>
    <span class="filter-count" id="count"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th data-col="case_id">Case <span class="arrow">▲</span></th>
        <th data-col="title">Title <span class="arrow">▲</span></th>
        <th data-col="decision">Decision <span class="arrow">▲</span></th>
        <th data-col="confidence">Confidence <span class="arrow">▼</span></th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="overlay" id="overlay">
  <div class="drawer" id="drawer"></div>
</div>

<script>
(function(){
  let CASES = [];
  let sortCol = 'case_id', sortAsc = true;

  fetch('data/cases.json').then(r=>r.json()).then(data=>{
    CASES = data;
    render();
  });

  const $search = document.getElementById('search');
  const $decision = document.getElementById('decisionFilter');
  const $conf = document.getElementById('confRange');
  const $confLabel = document.getElementById('confLabel');
  const $count = document.getElementById('count');
  const $tbody = document.getElementById('tbody');
  const $overlay = document.getElementById('overlay');
  const $drawer = document.getElementById('drawer');

  $search.addEventListener('input', render);
  $decision.addEventListener('change', render);
  $conf.addEventListener('input', ()=>{ $confLabel.textContent = $conf.value+'%'; render(); });

  document.querySelectorAll('thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const col = th.dataset.col;
      if(sortCol===col) sortAsc=!sortAsc; else { sortCol=col; sortAsc=true; }
      document.querySelectorAll('thead th').forEach(t=>t.classList.remove('sorted'));
      th.classList.add('sorted');
      th.querySelector('.arrow').textContent = sortAsc?'▲':'▼';
      render();
    });
  });

  $overlay.addEventListener('click', e=>{ if(e.target===$overlay) closeDrawer(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });

  function filtered(){
    const q = $search.value.toLowerCase();
    const d = $decision.value;
    const minConf = parseInt($conf.value)/100;
    return CASES.filter(c=>{
      if(d && c.decision!==d) return false;
      if(c.confidence < minConf) return false;
      if(q && !(c.case_id+' '+c.title+' '+c.reasons.join(' ')).toLowerCase().includes(q)) return false;
      return true;
    });
  }

  function sorted(arr){
    return [...arr].sort((a,b)=>{
      let va=a[sortCol], vb=b[sortCol];
      if(typeof va==='number'&&typeof vb==='number') return sortAsc?va-vb:vb-va;
      va=String(va); vb=String(vb);
      return sortAsc?va.localeCompare(vb):vb.localeCompare(va);
    });
  }

  function badgeClass(d){ return 'badge badge-'+d; }
  function confColor(v){
    if(v>=0.6) return 'var(--green)';
    if(v>=0.3) return 'var(--orange)';
    return 'var(--red)';
  }

  function render(){
    const list = sorted(filtered());
    $count.textContent = list.length+' of '+CASES.length+' cases';
    $tbody.innerHTML = list.map(c=>`
      <tr data-id="${c.case_id}">
        <td style="font-weight:600;font-variant-numeric:tabular-nums">${c.case_id.replace('case_','')}</td>
        <td>${esc(c.title)}</td>
        <td><span class="${badgeClass(c.decision)}">${c.decision.replace(/_/g,' ')}</span></td>
        <td>
          <span class="conf-bar">
            <span class="bar"><span class="fill" style="width:${c.confidence*100}%;background:${confColor(c.confidence)}"></span></span>
            ${(c.confidence*100).toFixed(0)}%
          </span>
        </td>
      </tr>
    `).join('');
    $tbody.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click', ()=>openDrawer(tr.dataset.id));
    });
  }

  function openDrawer(id){
    const c = CASES.find(x=>x.case_id===id);
    if(!c) return;
    $drawer.innerHTML = `
      <button class="drawer-close" onclick="document.getElementById('overlay').classList.remove('open')">&times;</button>
      <h2>${esc(c.title)}</h2>
      <div class="meta">${c.case_id} &middot; ${c.domain} &middot; ${c.horizon_days||'?'}d horizon</div>

      <section>
        <h3>Decision</h3>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <span class="${badgeClass(c.decision)}" style="font-size:14px;padding:4px 14px">${c.decision.replace(/_/g,' ')}</span>
          <span class="conf-bar" style="font-size:15px">
            <span class="bar" style="width:64px"><span class="fill" style="width:${c.confidence*100}%;background:${confColor(c.confidence)}"></span></span>
            ${(c.confidence*100).toFixed(1)}% confidence
          </span>
        </div>
        <div class="tags">${c.reasons.map(r=>'<span class="tag">'+esc(r)+'</span>').join('')}</div>
      </section>

      <section>
        <h3>Signals</h3>
        <dl class="kv">
          <dt>Primary metric</dt><dd>${c.primary_metric}</dd>
          <dt>Effect</dt><dd>${c.effect_pct!==null?c.effect_pct+'%':'—'}</dd>
          <dt>Stat. significant</dt><dd>${c.is_stat_sig?'Yes':'No'}</dd>
          <dt>Guardrails</dt><dd>${c.guardrails_ok?'<span style="color:var(--green)">OK</span>':'<span style="color:var(--red)">Violated</span>'}</dd>
          <dt>Practical threshold</dt><dd>${c.practical_threshold_pct}%</dd>
          <dt>Segments</dt><dd>${c.segments&&c.segments.length?c.segments.join(', '):'—'}</dd>
          <dt>Variants</dt><dd>${(c.variants||[]).join(', ')}</dd>
        </dl>
      </section>

      ${c.guardrails&&c.guardrails.length?`
      <section>
        <h3>Guardrails</h3>
        <dl class="kv">
          ${c.guardrails.map(g=>`<dt>${g.name}</dt><dd>max drop ${(g.max_drop_relative*100).toFixed(0)}% (${g.direction})</dd>`).join('')}
        </dl>
      </section>`:''}

      <section>
        <h3>Rationale</h3>
        <div class="rationale">${esc(c.summary)}</div>
      </section>

      ${c.notes?`<section><h3>Notes</h3><p style="font-size:14px;color:var(--muted)">${esc(c.notes)}</p></section>`:''}
    `;
    $overlay.classList.add('open');
  }

  function closeDrawer(){ $overlay.classList.remove('open'); }
  function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
})();
</script>
</body>
</html>
