<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trace Viewer — AB Factory</title>
<style>
:root {
  --bg: #fafafa; --fg: #1d1d1f; --muted: #6e6e73;
  --accent: #0071e3; --accent-hover: #0077ed;
  --card-bg: #fff; --border: #d2d2d7; --hover-bg: #f0f0f5;
  --green: #34c759; --red: #ff3b30; --orange: #ff9500; --purple: #af52de; --blue: #007aff;
  --radius: 12px;
}
@media(prefers-color-scheme:dark){:root{
  --bg:#000; --fg:#f5f5f7; --muted:#86868b;
  --accent:#2997ff; --accent-hover:#40a9ff;
  --card-bg:#1c1c1e; --border:#38383a; --hover-bg:#2c2c2e;
  --green:#30d158; --red:#ff453a; --orange:#ffa00a; --purple:#bf5af2; --blue:#0a84ff;
}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg);line-height:1.5;-webkit-font-smoothing:antialiased}

.top-bar{position:sticky;top:0;background:color-mix(in srgb,var(--bg) 80%,transparent);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;z-index:10}
.top-bar a{color:var(--accent);text-decoration:none;font-size:14px;font-weight:500}
.top-bar .title{font-weight:600;font-size:15px;color:var(--fg)}

.container{max-width:960px;margin:0 auto;padding:32px 24px 80px}
h1{font-size:28px;font-weight:700;margin-bottom:4px}
.subtitle{color:var(--muted);font-size:15px;margin-bottom:32px}

.explainer{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:32px}
.explainer h2{font-size:18px;font-weight:600;margin-bottom:12px}
.explainer p{font-size:14px;color:var(--muted);margin-bottom:8px}
.explainer code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:13px}
.explainer .cmd{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;margin-top:12px;overflow-x:auto;color:var(--fg)}

.case-picker{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
.case-btn{padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:var(--card-bg);color:var(--fg);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s}
.case-btn:hover{border-color:var(--accent);color:var(--accent)}
.case-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.timeline-wrap{position:relative}
.timeline-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;margin-top:24px}

.swim-lane{display:grid;grid-template-columns:90px 1fr;gap:0;margin-bottom:2px}
.lane-label{font-size:13px;font-weight:600;padding:10px 12px 10px 0;text-align:right;border-right:2px solid var(--border)}
.lane-events{display:flex;align-items:center;gap:0;padding:6px 0 6px 16px;position:relative;min-height:40px}

.evt{position:relative;display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;cursor:default;transition:transform 0.1s}
.evt:hover{transform:scale(1.05);z-index:2}
.evt .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

.evt-reader .dot{background:var(--blue)}
.evt-stats .dot{background:var(--purple)}
.evt-decision .dot{background:var(--orange)}
.evt-viz .dot{background:var(--green)}
.evt-reader{background:color-mix(in srgb,var(--blue) 10%,transparent)}
.evt-stats{background:color-mix(in srgb,var(--purple) 10%,transparent)}
.evt-decision{background:color-mix(in srgb,var(--orange) 10%,transparent)}
.evt-viz{background:color-mix(in srgb,var(--green) 10%,transparent)}

.decision-banner{margin-top:20px;padding:16px 20px;border-radius:var(--radius);border:1px solid var(--border);background:var(--card-bg);display:flex;align-items:center;gap:16px}
.decision-banner .verdict{font-size:18px;font-weight:700}
.badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:13px;font-weight:600}
.badge-ship{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.badge-do_not_ship{background:color-mix(in srgb,var(--red) 15%,transparent);color:var(--red)}
.badge-investigate{background:color-mix(in srgb,var(--orange) 15%,transparent);color:var(--orange)}
.conf-bar{display:inline-flex;align-items:center;gap:6px;font-size:14px}
.conf-bar .bar{width:56px;height:6px;border-radius:3px;background:var(--border);overflow:hidden}
.conf-bar .bar .fill{height:100%;border-radius:3px}

.legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:32px;padding-top:16px;border-top:1px solid var(--border)}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
.legend-item .swatch{width:10px;height:10px;border-radius:50%}

footer{text-align:center;padding:40px 24px;font-size:13px;color:var(--muted);border-top:1px solid var(--border)}
</style>
</head>
<body>

<div class="top-bar">
  <a href="index.html">&larr; Home</a>
  <span class="title">Trace Viewer</span>
</div>

<div class="container">
  <h1>Agent Traces</h1>
  <p class="subtitle">Visualize the reader → stats → decision → viz pipeline for each case.</p>

  <div class="explainer">
    <h2>How traces work</h2>
    <p>Each case run produces a <code>traces.jsonl</code> file — one JSON event per line. Events are emitted by agents as they execute: <code>reader</code> loads data, <code>stats</code> runs sanity checks, <code>decision</code> applies the policy framework, and <code>viz</code> generates comparison tables.</p>
    <p>Every event includes: <code>agent</code>, <code>step</code> (start/done/error), <code>event</code> type, <code>message</code>, and a free-form <code>payload</code>. Decision events carry the verdict + confidence.</p>
    <p style="margin-top:12px;margin-bottom:0">Generate real traces locally:</p>
    <div class="cmd">cd ~/projects/ab-factory-demo && ./42_workflows/ab_factory/run.sh</div>
  </div>

  <div class="case-picker" id="picker"></div>
  <div id="timeline"></div>

  <div class="legend">
    <div class="legend-item"><div class="swatch" style="background:var(--blue)"></div> reader</div>
    <div class="legend-item"><div class="swatch" style="background:var(--purple)"></div> stats</div>
    <div class="legend-item"><div class="swatch" style="background:var(--orange)"></div> decision</div>
    <div class="legend-item"><div class="swatch" style="background:var(--green)"></div> viz</div>
  </div>
</div>

<footer>AB Factory Demo &middot; traces are JSONL &middot; no dependencies</footer>

<script>
(function(){
  let TRACES = [];
  let activeCase = '';

  fetch('data/sample_traces.json').then(r=>r.json()).then(data=>{
    TRACES = data;
    const cases = [...new Set(data.map(t=>t.case_id))];
    const $picker = document.getElementById('picker');
    cases.forEach((cid,i)=>{
      const btn = document.createElement('button');
      btn.className = 'case-btn' + (i===0?' active':'');
      btn.textContent = cid.replace('case_','Case ');
      btn.addEventListener('click', ()=>{
        $picker.querySelectorAll('.case-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        showCase(cid);
      });
      $picker.appendChild(btn);
    });
    if(cases.length) showCase(cases[0]);
  });

  function showCase(cid){
    activeCase = cid;
    const evts = TRACES.filter(t=>t.case_id===cid);
    const agents = ['reader','stats','decision','viz'];
    const $tl = document.getElementById('timeline');

    let decision = null, confidence = null;
    evts.forEach(e=>{ if(e.decision){ decision=e.decision; confidence=e.confidence; }});

    let html = '<div class="timeline-wrap">';
    html += '<div class="timeline-label">Pipeline timeline</div>';

    agents.forEach(agent=>{
      const ae = evts.filter(e=>e.agent===agent);
      if(!ae.length) return;
      html += '<div class="swim-lane">';
      html += `<div class="lane-label">${agent}</div>`;
      html += '<div class="lane-events">';
      ae.forEach(e=>{
        html += `<div class="evt evt-${agent}" title="${esc(e.message)}">`;
        html += `<span class="dot"></span>`;
        html += `<span>${esc(e.event)}</span>`;
        html += `<span style="color:var(--muted);font-size:11px">${e.offset_ms}ms</span>`;
        html += '</div> ';
      });
      html += '</div></div>';
    });
    html += '</div>';

    if(decision){
      const confPct = ((confidence||0)*100).toFixed(0);
      const color = confidence>=0.6?'var(--green)':confidence>=0.3?'var(--orange)':'var(--red)';
      html += `<div class="decision-banner">
        <span class="verdict">Verdict</span>
        <span class="badge badge-${decision}">${decision.replace(/_/g,' ')}</span>
        <span class="conf-bar">
          <span class="bar"><span class="fill" style="width:${confPct}%;background:${color}"></span></span>
          ${confPct}% confidence
        </span>
      </div>`;
    }

    $tl.innerHTML = html;
  }

  function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
})();
</script>
</body>
</html>
