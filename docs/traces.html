<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trace Viewer â€” AB Factory</title>
<style>
:root {
  --bg: #fafafa; --fg: #1d1d1f; --muted: #6e6e73;
  --accent: #0071e3; --accent-hover: #0077ed;
  --card-bg: #fff; --border: #d2d2d7; --hover-bg: #f0f0f5;
  --green: #34c759; --red: #ff3b30; --orange: #ff9500; --purple: #af52de; --blue: #007aff;
  --radius: 12px;
}
@media(prefers-color-scheme:dark){:root{
  --bg:#000; --fg:#f5f5f7; --muted:#86868b;
  --accent:#2997ff; --accent-hover:#40a9ff;
  --card-bg:#1c1c1e; --border:#38383a; --hover-bg:#2c2c2e;
  --green:#30d158; --red:#ff453a; --orange:#ffa00a; --purple:#bf5af2; --blue:#0a84ff;
}}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif;background:var(--bg);color:var(--fg);line-height:1.5;-webkit-font-smoothing:antialiased}

.top-bar{position:sticky;top:0;background:color-mix(in srgb,var(--bg) 80%,transparent);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;z-index:10}
.top-bar a{color:var(--accent);text-decoration:none;font-size:14px;font-weight:500}
.top-bar .title{font-weight:600;font-size:15px;color:var(--fg)}

.container{max-width:960px;margin:0 auto;padding:32px 24px 80px}
h1{font-size:28px;font-weight:700;margin-bottom:4px}
.subtitle{color:var(--muted);font-size:15px;margin-bottom:32px}

.explainer{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:32px}
.explainer h2{font-size:18px;font-weight:600;margin-bottom:12px}
.explainer p{font-size:14px;color:var(--muted);margin-bottom:8px}
.explainer code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:13px}
.explainer .cmd{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;margin-top:12px;overflow-x:auto;color:var(--fg)}

.case-picker{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
.case-btn{padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:var(--card-bg);color:var(--fg);font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s}
.case-btn:hover{border-color:var(--accent);color:var(--accent)}
.case-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

.timeline-wrap{position:relative}
.timeline-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;margin-top:24px}

.swim-lane{display:grid;grid-template-columns:90px 1fr;gap:0;margin-bottom:2px}
.lane-label{font-size:13px;font-weight:600;padding:10px 12px 10px 0;text-align:right;border-right:2px solid var(--border)}
.lane-events{display:flex;align-items:center;gap:0;padding:6px 0 6px 16px;position:relative;min-height:40px}

.evt{position:relative;display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;cursor:default;transition:transform 0.1s}
.evt:hover{transform:scale(1.05);z-index:2}
.evt .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

.evt-reader .dot{background:var(--blue)}
.evt-stats .dot{background:var(--purple)}
.evt-decision .dot{background:var(--orange)}
.evt-viz .dot{background:var(--green)}
.evt-reader{background:color-mix(in srgb,var(--blue) 10%,transparent)}
.evt-stats{background:color-mix(in srgb,var(--purple) 10%,transparent)}
.evt-decision{background:color-mix(in srgb,var(--orange) 10%,transparent)}
.evt-viz{background:color-mix(in srgb,var(--green) 10%,transparent)}

.decision-banner{margin-top:20px;padding:16px 20px;border-radius:var(--radius);border:1px solid var(--border);background:var(--card-bg);display:flex;align-items:center;gap:16px}
.decision-banner .verdict{font-size:18px;font-weight:700}
.badge{display:inline-block;padding:3px 12px;border-radius:20px;font-size:13px;font-weight:600}
.badge-ship{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.badge-do_not_ship{background:color-mix(in srgb,var(--red) 15%,transparent);color:var(--red)}
.badge-investigate{background:color-mix(in srgb,var(--orange) 15%,transparent);color:var(--orange)}
.conf-bar{display:inline-flex;align-items:center;gap:6px;font-size:14px}
.conf-bar .bar{width:56px;height:6px;border-radius:3px;background:var(--border);overflow:hidden}
.conf-bar .bar .fill{height:100%;border-radius:3px}

.legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:32px;padding-top:16px;border-top:1px solid var(--border)}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
.legend-item .swatch{width:10px;height:10px;border-radius:50%}

footer{text-align:center;padding:40px 24px;font-size:13px;color:var(--muted);border-top:1px solid var(--border)}
</style>
</head>
<body>

<div class="top-bar">
  <a href="index.html" data-t="nav_home">&larr; Home</a>
  <span class="title" data-t="nav_title">Trace Viewer</span>
</div>

<div class="container">
  <h1 data-t="h1">Agent Traces</h1>
  <p class="subtitle" data-t="subtitle">Visualize the reader &rarr; stats &rarr; decision &rarr; viz pipeline for each case.</p>

  <div class="explainer">
    <h2 data-t="how_title">How traces work</h2>
    <p data-t="how_p1">Each case run produces a <code>traces.jsonl</code> file &mdash; one JSON event per line. Events are emitted by agents as they execute: <code>reader</code> loads data, <code>stats</code> runs sanity checks, <code>decision</code> applies the policy framework, and <code>viz</code> generates comparison tables.</p>
    <p data-t="how_p2">Every event includes: <code>agent</code>, <code>step</code> (start/done/error), <code>event</code> type, <code>message</code>, and a free-form <code>payload</code>. Decision events carry the verdict + confidence.</p>
    <p style="margin-top:12px;margin-bottom:0" data-t="how_generate">Generate real traces locally:</p>
    <div class="cmd">cd ~/projects/ab-factory-demo && ./42_workflows/ab_factory/run.sh</div>
  </div>

  <div class="case-picker" id="picker"></div>
  <div id="timeline"></div>

  <div class="legend">
    <div class="legend-item"><div class="swatch" style="background:var(--blue)"></div> reader</div>
    <div class="legend-item"><div class="swatch" style="background:var(--purple)"></div> stats</div>
    <div class="legend-item"><div class="swatch" style="background:var(--orange)"></div> decision</div>
    <div class="legend-item"><div class="swatch" style="background:var(--green)"></div> viz</div>
  </div>
</div>

<footer data-t="footer">AB Factory Demo &middot; traces are JSONL &middot; no dependencies</footer>

<script>
(function(){
  var params=new URLSearchParams(location.search);
  var LANG=params.get('lang')==='ru'?'ru':'en';
  var T={
    nav_home:{en:'\u2190 Home',ru:'\u2190 \u0413\u043b\u0430\u0432\u043d\u0430\u044f'},
    nav_title:{en:'Trace Viewer',ru:'\u041f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u0442\u0440\u0435\u0439\u0441\u043e\u0432'},
    h1:{en:'Agent Traces',ru:'\u0422\u0440\u0435\u0439\u0441\u044b \u0430\u0433\u0435\u043d\u0442\u043e\u0432'},
    subtitle:{en:'Visualize the reader \u2192 stats \u2192 decision \u2192 viz pipeline for each case.',ru:'\u0412\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u043f\u0430\u0439\u043f\u043b\u0430\u0439\u043d\u0430 reader \u2192 stats \u2192 decision \u2192 viz \u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u043a\u0435\u0439\u0441\u0430.'},
    how_title:{en:'How traces work',ru:'\u041a\u0430\u043a \u0440\u0430\u0431\u043e\u0442\u0430\u044e\u0442 \u0442\u0440\u0435\u0439\u0441\u044b'},
    how_p1:{en:'Each case run produces a <code>traces.jsonl</code> file \u2014 one JSON event per line. Events are emitted by agents as they execute: <code>reader</code> loads data, <code>stats</code> runs sanity checks, <code>decision</code> applies the policy framework, and <code>viz</code> generates comparison tables.',ru:'\u041a\u0430\u0436\u0434\u044b\u0439 \u0437\u0430\u043f\u0443\u0441\u043a \u043a\u0435\u0439\u0441\u0430 \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u0444\u0430\u0439\u043b <code>traces.jsonl</code> \u2014 \u043f\u043e \u043e\u0434\u043d\u043e\u043c\u0443 JSON-\u0441\u043e\u0431\u044b\u0442\u0438\u044e \u043d\u0430 \u0441\u0442\u0440\u043e\u043a\u0443. \u0410\u0433\u0435\u043d\u0442\u044b \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0442 \u0441\u043e\u0431\u044b\u0442\u0438\u044f \u043f\u043e \u043c\u0435\u0440\u0435 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f: <code>reader</code> \u0447\u0438\u0442\u0430\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0435, <code>stats</code> \u043f\u0440\u043e\u0432\u0435\u0440\u044f\u0435\u0442 \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u043e\u0441\u0442\u044c, <code>decision</code> \u043f\u0440\u0438\u043c\u0435\u043d\u044f\u0435\u0442 \u043f\u043e\u043b\u0438\u0442\u0438\u043a\u0443, <code>viz</code> \u0441\u0442\u0440\u043e\u0438\u0442 \u0442\u0430\u0431\u043b\u0438\u0446\u044b.'},
    how_p2:{en:'Every event includes: <code>agent</code>, <code>step</code> (start/done/error), <code>event</code> type, <code>message</code>, and a free-form <code>payload</code>. Decision events carry the verdict + confidence.',ru:'\u041a\u0430\u0436\u0434\u043e\u0435 \u0441\u043e\u0431\u044b\u0442\u0438\u0435 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442: <code>agent</code>, <code>step</code> (start/done/error), \u0442\u0438\u043f <code>event</code>, <code>message</code> \u0438 <code>payload</code>. \u0421\u043e\u0431\u044b\u0442\u0438\u044f decision \u043d\u0435\u0441\u0443\u0442 \u0432\u0435\u0440\u0434\u0438\u043a\u0442 \u0438 \u0443\u0432\u0435\u0440\u0435\u043d\u043d\u043e\u0441\u0442\u044c.'},
    how_generate:{en:'Generate real traces locally:',ru:'\u0421\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0442\u0440\u0435\u0439\u0441\u044b \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u043e:'},
    footer:{en:'AB Factory Demo \u00b7 traces are JSONL \u00b7 no dependencies',ru:'AB Factory Demo \u00b7 \u0442\u0440\u0435\u0439\u0441\u044b \u0432 JSONL \u00b7 \u0431\u0435\u0437 \u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e\u0441\u0442\u0435\u0439'},
    verdict:{en:'Verdict',ru:'\u0412\u0435\u0440\u0434\u0438\u043a\u0442'},
    confidence:{en:'confidence',ru:'\u0443\u0432\u0435\u0440\u0435\u043d\u043d\u043e\u0441\u0442\u044c'},
    pipeline_tl:{en:'Pipeline timeline',ru:'\u0422\u0430\u0439\u043c\u043b\u0430\u0439\u043d \u043f\u0430\u0439\u043f\u043b\u0430\u0439\u043d\u0430'}
  };
  function t(k){var e=T[k];return e?(e[LANG]||e.en):k;}

  if(LANG==='ru'){
    document.documentElement.lang='ru';
    document.querySelectorAll('[data-t]').forEach(function(el){
      var v=t(el.getAttribute('data-t'));
      if(v) el.innerHTML=v;
    });
    var homeLink=document.querySelector('.top-bar a[href*="index"]');
    if(homeLink&&homeLink.href.indexOf('lang=')<0){
      homeLink.href=homeLink.href+(homeLink.href.indexOf('?')>=0?'&':'?')+'lang=ru';
    }
  }

  var REPLAY_INDEX = [];
  var REPLAY_CACHE = {};
  var PICKER_CASES = [];
  var activeCase = '';
  var NUM_PICKER = 8;

  fetch('data/replays/index.json').then(function(r){return r.json();}).then(function(idx){
    REPLAY_INDEX = idx;
    PICKER_CASES = idx.slice(0, NUM_PICKER);
    var $picker = document.getElementById('picker');
    PICKER_CASES.forEach(function(entry, i){
      var btn = document.createElement('button');
      btn.className = 'case-btn' + (i===0?' active':'');
      btn.textContent = entry.case_id.replace('case_','Case ');
      btn.addEventListener('click', function(){
        $picker.querySelectorAll('.case-btn').forEach(function(b){b.classList.remove('active');});
        btn.classList.add('active');
        loadAndShow(entry.case_id);
      });
      $picker.appendChild(btn);
    });
    if(PICKER_CASES.length) loadAndShow(PICKER_CASES[0].case_id);
  });

  function loadAndShow(cid){
    activeCase = cid;
    var $tl = document.getElementById('timeline');
    if(REPLAY_CACHE[cid]){showCase(REPLAY_CACHE[cid]);return;}
    $tl.innerHTML = '<p style="color:var(--muted)">Loading\u2026</p>';
    fetch('data/replays/'+cid+'.json').then(function(r){return r.json();}).then(function(rp){
      REPLAY_CACHE[cid] = rp;
      if(activeCase === cid) showCase(rp);
    }).catch(function(){
      if(activeCase === cid) $tl.innerHTML = '<p style="color:var(--muted)">Replay not available.</p>';
    });
  }

  function showCase(rp){
    var evts = rp.timeline || [];
    var agents = ['reader','stats','decision','viz'];
    var $tl = document.getElementById('timeline');

    var html = '<div class="timeline-wrap">';
    html += '<div class="timeline-label">'+t('pipeline_tl')+'</div>';

    agents.forEach(function(agent){
      var ae = evts.filter(function(e){return e.agent===agent;});
      if(!ae.length) return;
      html += '<div class="swim-lane">';
      html += '<div class="lane-label">'+agent+'</div>';
      html += '<div class="lane-events">';
      ae.forEach(function(e){
        html += '<div class="evt evt-'+agent+'" title="'+esc(e.message)+'">';
        html += '<span class="dot"></span>';
        html += '<span>'+esc(e.event_type)+'</span>';
        html += '<span style="color:var(--muted);font-size:11px">'+e.t_ms+'ms</span>';
        html += '</div> ';
      });
      html += '</div></div>';
    });
    html += '</div>';

    var decision = rp.decision, confidence = rp.confidence;
    if(decision){
      var confPct = ((confidence||0)*100).toFixed(0);
      var color = confidence>=0.6?'var(--green)':confidence>=0.3?'var(--orange)':'var(--red)';
      html += '<div class="decision-banner">';
      html += '<span class="verdict">'+t('verdict')+'</span>';
      html += '<span class="badge badge-'+decision+'">'+decision.replace(/_/g,' ')+'</span>';
      html += '<span class="conf-bar">';
      html += '<span class="bar"><span class="fill" style="width:'+confPct+'%;background:'+color+'"></span></span>';
      html += confPct+'% '+t('confidence');
      html += '</span></div>';
    }

    $tl.innerHTML = html;
  }

  function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
})();
</script>
</body>
</html>
